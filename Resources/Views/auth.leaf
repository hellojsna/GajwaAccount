<!DOCTYPE html>
<html lang="ko">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gajwa Account</title>
    <style>
        @import url("/styles/root.css");
        @import url("/styles/auth.css");
    </style>
</head>

<body>
    <div id="mainViewContainer" class="mainViewContainer">
        <h1>Gajwa Account</h1>
        <p>하나의 계정으로 모든 서비스 이용</p>
        <div id="loginView" class="authView active">
            <form id="loginForm">
                <button type="submit">패스키로 로그인</button>
            </form>
            <a id="showRegisterView" href="#registerView">회원 가입</a>
        </div>
        <div id="registerView" class="authView">
            <form id="registerForm">
                <label for="userLoginID">로그인 ID</label>
                <input id="userLoginID" type="text">
                <label for="userName">이름</label>
                <input id="userName" type="text">
                <label for="userStudentID">#(academicYear)학년도 기준 학번</label>
                <input id="userStudentID" type="number">
                <label for="userEmail">이메일</label>
                <input id="userEmail" type="email">
                <button type="submit">회원 가입</button>
            </form>
            <a id="showLoginView" href="#loginView">로그인</a>
        </div>
    </div>
    <script type="module">
        const month = new Date().getMonth() + 1;
        const academicYear = month >= 3 ? new Date().getFullYear() : new Date().getFullYear() - 1;

        if (window.PublicKeyCredential &&
            PublicKeyCredential.isUserVerifyingPlatformAuthenticatorAvailable &&
            PublicKeyCredential.isConditionalMediationAvailable) {
            // Check if user verifying platform authenticator is available.  
            Promise.all([
                PublicKeyCredential.isUserVerifyingPlatformAuthenticatorAvailable(),
                PublicKeyCredential.isConditionalMediationAvailable(),
            ]).then(results => {
                if (results.every(r => r === true)) {
                    const registerForm = document.getElementById("registerForm");
                    registerForm.addEventListener("submit", async function (event) {
                        event.preventDefault();

                        const userLoginID = document.getElementById("userLoginID").value;
                        const userName = document.getElementById("userName").value;
                        const userStudentID = document.getElementById("userStudentID").value;

                        const userStudentIDList = `${academicYear}-${userStudentID}`;
                        const userEmail = document.getElementById("userEmail").value;

                        const registerResponse = await fetch(`/api/v1/auth/register?userLoginID=${userLoginID}&userName=${userName}&userStudentIDList=${userStudentIDList}&userEmail=${userEmail}`);
                        const registerResponseJSON = await registerResponse.json();

                        const publicKey = PublicKeyCredential.parseCreationOptionsFromJSON(registerResponseJSON.publicKey);
                        publicKey.authenticatorSelection = {
                            ...(publicKey.authenticatorSelection ?? {}),
                            residentKey: "preferred",
                            userVerification: "preferred",
                        };
                        console.log("publicKey", publicKey);


                        const credential = await navigator.credentials.create({ publicKey });
                        const passkey = credential.toJSON();
                        const createPasskeyResponse = await fetch("/api/v1/auth/register", {
                            method: "POST",
                            headers: {
                                "Content-Type": "application/json"
                            },
                            body: JSON.stringify(passkey)
                        });
                    });

                    const loginForm = document.getElementById("loginForm");
                    loginForm.addEventListener("submit", async function (event) {
                        event.preventDefault();

                        try {
                            const loginResponse = await fetch("/api/v1/auth/login");
                            const loginResponseJSON = await loginResponse.json();

                            const publicKey = PublicKeyCredential.parseRequestOptionsFromJSON(loginResponseJSON.publicKey);
                            const credential = await navigator.credentials.get({ publicKey });

                            const loginAttemptResponse = await fetch("/api/v1/auth/login", {
                                method: "POST",
                                headers: { "Content-Type": "application/json" },
                                body: JSON.stringify(credential.toJSON())
                            });

                            if (loginAttemptResponse.ok) {
                                location.href = "/home";
                            }
                        } catch (error) {
                            console.error(error);
                        }
                    });
                }
            });
        }  
    </script>
    <script src="/scripts/auth.js"></script>
</body>

</html>