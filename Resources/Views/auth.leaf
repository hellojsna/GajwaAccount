<!DOCTYPE html>
<html lang="ko">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gajwa Account</title>
    <style>
        @import url("/styles/root.css");
        @import url("/styles/footer.css");
        @import url("/styles/auth.css");
    </style>
</head>

<body>
    <div class="authContainer">
        <main class="authMain">
            <div id="loginView" class="viewWrapper active">
                <div class="card">
                    <div class="cardHeader">
                        <h2 class="heading large">로그인</h2>
                        <p class="body medium">패스키로 로그인할 수 있습니다.</p>
                    </div>
                    <form id="loginForm" class="form">
                        <button type="submit" class="button primaryButton buttonLarge">패스키로 로그인</button>
                    </form>
                    <button id="showPasswordLogin" class="button secondaryButton buttonLarge">비밀번호로 로그인</button>
                    <div class="cardFooter">
                        <button id="showRegisterView" class="link">회원가입</button>
                    </div>
                </div>
            </div>

            <div id="passwordLoginView" class="viewWrapper">
                <div class="card">
                    <div class="cardHeader">
                        <h2 class="heading large">비밀번호로 로그인</h2>
                        <p class="body medium">계정 정보를 입력해주세요.</p>
                    </div>
                    <form id="passwordLoginForm" class="form">
                        <div class="inputGroup">
                            <label class="body medium">로그인 ID</label>
                            <input id="passwordLoginID" type="text" placeholder="gildong" autocomplete="username">
                        </div>
                        <div class="inputGroup">
                            <label class="body medium">비밀번호</label>
                            <input id="passwordLoginPassword" type="password" placeholder="" autocomplete="current-password">
                        </div>
                        <button type="submit" class="button primaryButton buttonLarge">로그인</button>
                    </form>
                    <div class="cardFooter">
                        <button id="showPasskeyLogin" class="link">패스키로 로그인</button>
                    </div>
                </div>
            </div>

            <div id="registerView" class="viewWrapper">
                <div class="card">
                    <div class="cardHeader">
                        <h2 class="heading large" id="registerTitle">회원가입</h2>
                    </div>
                    
                    <div class="progressContainer">
                        <div class="progressBar">
                            <div class="progressFill" id="progressFill"></div>
                        </div>
                        <p class="body xsmall" id="progressText">1 / 6</p>
                    </div>

                    <form id="registerForm" class="form">
                        <div class="formStep active" data-step="1">
                            <div class="inputGroup">
                                <label class="body medium">이름</label>
                                <input id="userName" type="text" placeholder="홍길동" autocomplete="name">
                            </div>
                            <button type="button" class="button primaryButton buttonLarge nextStep">다음</button>
                        </div>

                        <div class="formStep" data-step="2">
                            <div class="inputGroup">
                                <label class="body medium">학번</label>
                                <div class="studentIdInput">
                                    <span class="body medium" id="academicYear"></span>
                                    <input id="userStudentID" type="text" inputmode="numeric" pattern="\d*" placeholder="12345" maxlength="5">
                                </div>
                                <p class="inputHint body xsmall">5자리 숫자를 입력하세요.</p>
                            </div>
                            <div class="buttonGroup">
                                <button type="button" class="button secondaryButton prevStep">이전</button>
                                <button type="button" class="button primaryButton nextStep">다음</button>
                            </div>
                        </div>

                        <div class="formStep" data-step="3">
                            <div class="inputGroup">
                                <label class="body medium">이메일</label>
                                <input id="userEmail" type="email" placeholder="gildong@example.com" autocomplete="email">
                                <p class="inputHint body xsmall">암호 복구에 사용됩니다.</p>
                            </div>
                            <div class="buttonGroup">
                                <button type="button" class="button secondaryButton prevStep">이전</button>
                                <button type="button" class="button primaryButton nextStep">다음</button>
                            </div>
                        </div>

                        <div class="formStep" data-step="4">
                            <div class="inputGroup">
                                <label class="body medium">로그인 ID</label>
                                <input id="userLoginID" type="text" placeholder="gildong" autocomplete="username">
                                <p class="inputHint body xsmall">영문 또는 숫자만 사용할 수 있습니다.</p>
                            </div>
                            <div class="buttonGroup">
                                <button type="button" class="button secondaryButton prevStep">이전</button>
                                <button type="button" class="button primaryButton nextStep">다음</button>
                            </div>
                        </div>

                        <div class="formStep" data-step="5">
                            <div class="inputGroup">
                                <label class="body medium">비밀번호</label>
                                <input id="userLoginPassword" type="password" placeholder="" autocomplete="new-password">
                                <p class="inputHint body xsmall">8자 이상 입력하세요.</p>
                            </div>
                            <div class="buttonGroup">
                                <button type="button" class="button secondaryButton prevStep">이전</button>
                                <button type="button" class="button primaryButton nextStep">다음</button>
                            </div>
                        </div>

                        <div class="formStep" data-step="6">
                            <div class="inputGroup">
                                <p class="body medium">앞으로 이 기기에서는 비밀번호 없이 편리하게 로그인할 수 있습니다.</p>
                            </div>
                            <div class="buttonGroup">
                                <button type="button" class="button secondaryButton" id="skipPasskey">건너뛰기</button>
                                <button type="submit" class="button primaryButton">패스키 저장</button>
                            </div>
                        </div>
                    </form>

                    <div class="cardFooter">
                        <button id="showLoginView" class="link">로그인</button>
                    </div>
                </div>
            </div>
        </main>

        #extend("footer")
    </div>

    <script type="module">
        const month = new Date().getMonth() + 1;
        const academicYear = month >= 3 ? new Date().getFullYear() : new Date().getFullYear() - 1;
        document.getElementById('academicYear').textContent = academicYear + ' -';
        let registrationOptions = null;

        if (window.PublicKeyCredential &&
            PublicKeyCredential.isUserVerifyingPlatformAuthenticatorAvailable &&
            PublicKeyCredential.isConditionalMediationAvailable) {
            Promise.all([
                PublicKeyCredential.isUserVerifyingPlatformAuthenticatorAvailable(),
                PublicKeyCredential.isConditionalMediationAvailable(),
            ]).then(results => {
                if (results.every(r => r === true)) {
                    window.prepareRegistration = async function () {
                        if (registrationOptions) {
                            return true;
                        }

                        const userLoginID = document.getElementById("userLoginID").value;
                        const userLoginPassword = document.getElementById("userLoginPassword").value;
                        const userName = document.getElementById("userName").value;
                        const userStudentID = document.getElementById("userStudentID").value;
                        const userStudentIDList = `${academicYear}-${userStudentID}`;
                        const userEmail = document.getElementById("userEmail").value;

                        const registerResponse = await fetch("/api/v1/auth/register/create", {
                            method: "POST",
                            headers: { "Content-Type": "application/json" },
                            body: JSON.stringify({
                                userLoginID,
                                userLoginPassword,
                                userName,
                                userStudentIDList,
                                userEmail
                            })
                        });
                        if (!registerResponse.ok) {
                            console.error("Failed to create user");
                            return false;
                        }

                        registrationOptions = await registerResponse.json();
                        return true;
                    };

                    const registerForm = document.getElementById("registerForm");
                    registerForm.addEventListener("submit", async function (event) {
                        event.preventDefault();

                        if (!registrationOptions) {
                            console.error("Registration options not prepared");
                            return;
                        }

                        const publicKey = PublicKeyCredential.parseCreationOptionsFromJSON(registrationOptions.publicKey);
                        publicKey.authenticatorSelection = {
                            ...(publicKey.authenticatorSelection ?? {}),
                            residentKey: "preferred",
                            userVerification: "preferred",
                        };

                        const credential = await navigator.credentials.create({ publicKey });
                        const passkey = credential.toJSON();
                        await fetch("/api/v1/auth/register/passkey", {
                            method: "POST",
                            headers: { "Content-Type": "application/json" },
                            body: JSON.stringify(passkey)
                        });
                        location.href = "/home";
                    });

                    const skipPasskeyButton = document.getElementById("skipPasskey");
                    skipPasskeyButton.addEventListener("click", async function (event) {
                        event.preventDefault();
                        try {
                            await fetch("/api/v1/auth/register/skip", { method: "POST" });
                        } catch (error) {
                            console.error(error);
                        }
                        location.href = "/home";
                    });

                    const loginForm = document.getElementById("loginForm");
                    loginForm.addEventListener("submit", async function (event) {
                        event.preventDefault();

                        try {
                            const loginResponse = await fetch("/api/v1/auth/login/passkey");
                            const loginResponseJSON = await loginResponse.json();

                            const publicKey = PublicKeyCredential.parseRequestOptionsFromJSON(loginResponseJSON.publicKey);
                            const credential = await navigator.credentials.get({ publicKey });

                            const loginAttemptResponse = await fetch("/api/v1/auth/login/passkey", {
                                method: "POST",
                                headers: { "Content-Type": "application/json" },
                                body: JSON.stringify(credential.toJSON())
                            });

                            if (loginAttemptResponse.ok) {
                                const result = await loginAttemptResponse.json();
                                location.href = result.redirectURL || "/home";
                            }
                        } catch (error) {
                            console.error(error);
                        }
                    });
                }
            });
        }
    </script>
    <script src="/scripts/auth.js"></script>
</body>

</html>